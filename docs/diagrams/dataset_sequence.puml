@startuml DatasetPipeline
title ./dataset.sh (local) — Produtor/Consumidor simplificado

actor Usuário
participant "dataset.sh" as Shell
participant "DatasetCLI\n(marsfill/cli/dataset.py)" as CLI
participant "get_profile" as Profile
participant "DatasetBuilder\n(produtores + consumidores)" as Builder
participant "Fila\n(multiprocessing.Queue)" as Queue
participant "Disco local" as Storage

Usuário -> Shell: ./dataset.sh --profile <p>
Shell -> CLI: python marsfill/cli/dataset.py args
CLI -> Profile: carregar perfil <p>
Profile --> CLI: make config (urls, paths, batch_size)
CLI -> Builder: instanciar e iniciar run()

== Produtores ==
loop pares indexados (80/20 train/val)
  Builder -> Builder: baixar DTM/ORTHO + warp\ncortar tiles válidos
  Builder -> Storage: salvar tiles temp (tif)
  Builder -> Queue: enqueue metadados\n(split, paths, coords)
end

== Consumidores ==
loop até poison pill
  Queue --> Builder: obter lote de metadados
  Builder -> Storage: ler tif temporários\nsalvar parquet (<split>/batch_*.parquet)
  Builder -> Storage: remover tif temporários
end

Builder --> CLI: finalizado
CLI --> Shell: status ok
Shell --> Usuário: dataset salvo em ./data/dataset/v1/<split>

@enduml
